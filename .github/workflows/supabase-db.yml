name: Supabase DB Migrations

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest

    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Environment Variables
        run: |
          echo "üîç Checking Supabase environment variables..."
          if [ -z "$SUPABASE_DB_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå ERROR: Missing Supabase secrets. Please set SUPABASE_DB_URL_PROD and SUPABASE_SERVICE_ROLE_KEY in repository secrets."
            exit 1
          fi
          echo "‚úÖ Secrets detected successfully."
          echo "Project Host: $(echo $SUPABASE_DB_URL | sed 's/^.*@//g' | cut -d':' -f1)"
          echo "Key Prefix: $(echo $SUPABASE_SERVICE_ROLE_KEY | cut -c1-6)..."

      - name: Install Supabase CLI
        run: |
          echo "üì¶ Installing Supabase CLI..."
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz -o supabase.tar.gz
          tar -xzf supabase.tar.gz -C /usr/local/bin
          chmod +x /usr/local/bin/supabase
          supabase --version
          
      - name: Test Supabase CLI Connection
        run: |
          echo "üß™ Testing Supabase CLI connection..."
          supabase db remote commit --db-url "$SUPABASE_DB_URL" || {
            echo "‚ùå Connection test failed. Check DB URL or network access."
            exit 1
          }
          echo "‚úÖ Connection verified."

      - name: Run Database Migrations
        run: |
          echo "üöÄ Running Supabase migrations on production database..."
          supabase db push --db-url "$SUPABASE_DB_URL" || {
            echo "‚ùå Migration failed. Check schema or permissions."
            exit 1
          }
          echo "‚úÖ Migration completed successfully."

      - name: Verify Database Schema
        run: |
          echo "üìã Verifying schema consistency..."
          supabase db remote commit --db-url "$SUPABASE_DB_URL"
          echo "‚úÖ Schema verification complete."

      - name: Cleanup
        run: |
          rm -f supabase.tar.gz
          echo "üßπ Cleanup complete."