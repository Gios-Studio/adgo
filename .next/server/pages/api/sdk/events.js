"use strict";(()=>{var a={};a.id=719,a.ids=[719],a.modules={3939:a=>{a.exports=require("@supabase/supabase-js")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7060:(a,b,c)=>{c.r(b),c.d(b,{config:()=>q,default:()=>p,handler:()=>s});var d={};c.r(d),c.d(d,{default:()=>j});var e=c(9046),f=c(8667),g=c(3480),h=c(6435);let i=(0,c(3939).createClient)("https://rkonwkggxaohpmxmzmfn.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function j(a,b){try{if("GET"===a.method)return await k(a,b);if("POST"===a.method)return await l(a,b);return b.status(405).json({error:"method_not_allowed"})}catch(a){console.error("SDK API Error:",a),b.status(500).json({error:a.message})}}async function k(a,b){let{ride_id:c,device_id:d,zone:e="post-ride"}=a.query;if(!c)return b.status(400).json({error:"missing_ride_id"});try{let{data:a,error:d}=await i.from("analytics_events").select("id").eq("ride_id",c).limit(1);if(d)throw d;if(a&&a.length>0)return b.status(200).json({ad:null,message:"frequency_cap_reached",ride_id:c});let{data:f,error:g}=await i.from("campaigns").select(`
        id, name, budget_cents, status,
        ads (id, title, media_url, status)
      `).eq("status","active").gt("budget_cents",0).limit(1);if(g)throw g;if(!f||0===f.length)return b.status(200).json({ad:null,message:"no_available_campaigns"});let h=f[0],j=h.ads?.filter(a=>"active"===a.status)||[];if(0===j.length)return b.status(200).json({ad:null,message:"no_active_ads"});let k=j[Math.floor(Math.random()*j.length)];return b.status(200).json({ad:{id:k.id,campaign_id:h.id,title:k.title,media_url:k.media_url,tracking_pixel:`/api/sdk/events?event_type=impression&campaign_id=${h.id}&ad_id=${k.id}&ride_id=${c}`,click_url:`/api/sdk/events?event_type=click&campaign_id=${h.id}&ad_id=${k.id}&ride_id=${c}`},ride_id:c,zone:e})}catch(a){return console.error("Serve ad error:",a),b.status(500).json({error:"Failed to serve ad"})}}async function l(a,b){let{campaign_id:c,ad_id:d,ride_id:e,device_id:f=null,zone:g="post-ride",event_type:h,meta:j={}}=a.body||{};if(!e||!h||!c||!d)return b.status(400).json({error:"missing_required_fields"});try{let{data:a,error:k}=await i.from("analytics_events").insert({campaign_id:c,ad_id:d,event_type:h,device_id:f,region:g,ride_id:e,meta:j}).select().single();if(k)throw k;"click"===h&&await m(e,c,d),b.status(200).json({success:!0,event_id:a.id,ride_id:e,event_type:h})}catch(a){return console.error("Record event error:",a),b.status(500).json({error:"Failed to record event"})}}async function m(a,b,c){try{let{data:b,error:c}=await i.from("wallets").select("id, balance_cents").not("driver_id","is",null).limit(1).single();if(c||!b)return void console.log("No driver wallet found for payout");let{error:d}=await i.from("transactions").insert({wallet_id:b.id,type:"credit",amount_cents:10,ref:`click_payout_${a}`,memo:`Click payout for ride ${a}`});if(d)throw d;let{error:e}=await i.from("wallets").update({balance_cents:b.balance_cents+10}).eq("id",b.id);if(e)throw e;console.log(`ðŸ’° Driver payout: 10 cents for ride ${a}`)}catch(a){console.error("Driver payout error:",a)}}var n=c(8112),o=c(6385);let p=(0,h.M)(d,"default"),q=(0,h.M)(d,"config"),r=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/sdk/events",pathname:"/api/sdk/events",bundlePath:"",filename:""},userland:d,distDir:".next",relativeProjectDir:""});async function s(a,b,c){let d=await r.prepare(a,b,{srcPage:"/api/sdk/events"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,n.getTracer)(),e=d.getActiveScopeSpan(),j=r.instrumentationOnRequestError.bind(r),k=async e=>r.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:r.isDev,page:"/api/sdk/events",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>j(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==o.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await k(e):await d.withPropagatedContext(a.headers,()=>d.trace(o.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},k))}catch(a){if(r.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=7060));module.exports=c})();