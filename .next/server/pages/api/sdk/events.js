"use strict";(()=>{var a={};a.id=5719,a.ids=[5719],a.modules={37:a=>{a.exports=import("uuid")},2480:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(9783),j=c(8112),k=c(6385),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/sdk/events",pathname:"/api/sdk/events",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/sdk/events"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/sdk/events",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},2971:a=>{a.exports=import("zod")},3939:a=>{a.exports=require("@supabase/supabase-js")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6472:a=>{a.exports=require("@opentelemetry/api")},9783:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>l});var e=c(3939),f=c(37),g=c(2971),h=a([f,g]);[f,g]=h.then?(await h)():h;let r=(0,e.createClient)("https://rkonwkggxaohpmxmzmfn.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),s=g.z.object({campaign_id:g.z.string().uuid(),ad_id:g.z.string().uuid(),ride_id:g.z.string().min(1),device_id:g.z.string().min(1).optional(),event_type:g.z.enum(["impression","click","conversion"]),zone:g.z.string().default("post-ride"),meta:g.z.record(g.z.any()).optional()}),t=g.z.object({events:g.z.array(s).min(1).max(50),batch_id:g.z.string().uuid().optional()});g.z.object({ride_id:g.z.string().min(1),device_id:g.z.string().min(1),zone:g.z.string().default("post-ride")});let u=g.z.object({ride_id:g.z.string().min(1).optional(),device_id:g.z.string().min(1).optional(),zone:g.z.string().default("post-ride"),limit:g.z.coerce.number().min(1).max(100).default(50),offset:g.z.coerce.number().min(0).default(0),since:g.z.string().datetime().optional(),campaign_id:g.z.string().uuid().optional(),event_type:g.z.enum(["impression","click","conversion"]).optional()}),v={maxRetries:3,baseDelay:100,maxDelay:2e3};function i(a){let b=a.ride_id,c=null,d={...a};return(0,f.validate)(b)||(c=b,b.startsWith("test_")||b.includes("test")?d.ride_id="619fee45-808f-4336-8468-54571cea537c":"00000000-0000-0000-0000-000000000300"===b?d.ride_id=b:d.ride_id=(0,f.v4)()),(0,f.validate)(d.campaign_id)||(console.log(`Invalid campaign_id: ${d.campaign_id}, generating new UUID`),d.campaign_id="ace29fa0-5765-4ce0-b856-074b3abad5e7"),(0,f.validate)(d.ad_id)||(console.log(`Invalid ad_id: ${d.ad_id}, generating new UUID`),d.ad_id="88c0a93e-493c-499a-8a0a-eaa2cdba6a2c"),{normalizedData:d,rideRef:c}}async function j(a){try{let{data:b,error:c}=await r.from("analytics_events").select("id, ride_id, event_type, created_at").eq("id",a).single();return!c&&b&&b.id===a}catch{return!1}}async function k(a,b="operation"){let c;for(let d=0;d<=v.maxRetries;d++)try{return await a()}catch(e){if(c=e,e.message?.includes("duplicate key")||"23505"===e.code)return console.log(`${b} detected duplicate key - returning early`),{isDuplicate:!0,message:"duplicate_entry"};if(e.code?.startsWith("23")||e.code?.startsWith("42"))throw e;if(d===v.maxRetries)throw console.error(`${b} failed after ${v.maxRetries+1} attempts:`,e),e;let a=Math.min(v.baseDelay*Math.pow(2,d),v.maxDelay);console.warn(`${b} attempt ${d+1} failed, retrying in ${a}ms:`,e.message),await new Promise(b=>setTimeout(b,a))}throw c}async function l(a,b){try{if(b.setHeader("X-AdGo-SDK-Version","1.0.0"),b.setHeader("X-Response-Time",Date.now().toString()),"GET"===a.method){if(a.query.limit||a.query.offset||a.query.since||a.query.event_type)return await m(a,b);return await n(a,b)}if("POST"===a.method)return await p(a,b);return b.status(405).json({error:"method_not_allowed",allowed_methods:["GET","POST"],sdk_version:"1.0.0"})}catch(a){return console.error("SDK Events API Error:",a),b.status(500).json({error:"internal_server_error",message:a.message,sdk_version:"1.0.0",timestamp:new Date().toISOString()})}}async function m(a,b){try{let c=u.safeParse(a.query);if(!c.success)return b.status(400).json({error:"invalid_query_parameters",details:c.error.issues,sdk_version:"1.0.0"});let{ride_id:d,device_id:e,zone:f,limit:g,offset:h,since:i,campaign_id:j,event_type:k}=c.data,l=r.from("analytics_events").select("id, campaign_id, ad_id, event_type, device_id, ride_id, region, created_at, occurred_at, meta",{count:"exact"}).order("created_at",{ascending:!1}).range(h,h+g-1);d&&(l=l.eq("ride_id",d)),e&&(l=l.eq("device_id",e)),f&&(l=l.eq("region",f)),j&&(l=l.eq("campaign_id",j)),k&&(l=l.eq("event_type",k)),i&&(l=l.gte("created_at",i));let{data:m,error:n,count:o}=await l;if(n)return console.error("Query events error:",n),b.status(500).json({error:"Failed to query events",sdk_version:"1.0.0"});let p=!!o&&h+g<o,q=p?h+g:null;return b.status(200).json({events:m||[],pagination:{limit:g,offset:h,total:o||0,hasMore:p,nextOffset:q},deltaSync:{since:i||null,latestTimestamp:m?.[0]?.created_at||null},sdk_version:"1.0.0",timestamp:new Date().toISOString()})}catch(a){return console.error("Query events error:",a),b.status(500).json({error:"Failed to query events",sdk_version:"1.0.0"})}}async function n(a,b){let{ride_id:c,device_id:d,zone:e="post-ride"}=a.query;if(!c)return b.status(400).json({error:"missing_ride_id"});let{normalizedData:f,rideRef:g}=i({ride_id:c}),h=f.ride_id;try{let{data:a,error:c}=await r.from("analytics_events").select("id").eq("ride_id",h).limit(1);if(c)throw c;if(a&&a.length>0)return b.status(200).json({ad:null,message:"frequency_cap_reached",ride_id:h});let{data:d,error:f}=await r.from("campaigns").select("id, name, budget_cents, status").eq("status","active").gt("budget_cents",0).limit(1);if(f)throw f;if(!d||0===d.length)return b.status(200).json({ad:null,message:"no_available_campaigns"});let g=d[0],{data:i,error:j}=await r.from("ads").select("id, title, media_url, status").eq("campaign_id",g.id).eq("status","active");if(j)throw j;if(!i||0===i.length)return b.status(200).json({ad:null,message:"no_active_ads"});let k=i[Math.floor(Math.random()*i.length)];return b.status(200).json({ad:{id:k.id,campaign_id:g.id,title:k.title,media_url:k.media_url,tracking_pixel:`/api/sdk/events?event_type=impression&campaign_id=${g.id}&ad_id=${k.id}&ride_id=${h}`,click_url:`/api/sdk/events?event_type=click&campaign_id=${g.id}&ad_id=${k.id}&ride_id=${h}`},ride_id:h,zone:e})}catch(a){return console.error("Serve ad error:",a),b.status(500).json({error:"Failed to serve ad"})}}async function o(a,b){try{let c=t.safeParse(a.body);if(!c.success)return b.status(400).json({error:"invalid_batch_parameters",details:c.error.issues,sdk_version:"1.0.0"});let{events:d,batch_id:e}=c.data,g=Date.now(),h=d.map(a=>{let{normalizedData:b,rideRef:c}=i(a),d=b.ride_id;return{campaign_id:a.campaign_id,ad_id:a.ad_id,ride_id:d,device_id:a.device_id||null,event_type:a.event_type,region:a.zone||"post-ride",occurred_at:new Date().toISOString(),meta:{...a.meta,batch_id:e,batch_processing:!0}}}),j=await k(async()=>{let{data:a,error:b}=await r.from("analytics_events").insert(h).select();if(b)throw b;return a}),l=Date.now()-g;return b.status(200).json({success:!0,batch_id:e||(0,f.v4)(),events_processed:j.length,processing_time_ms:l,event_ids:j.map(a=>a.id),sdk_version:"1.0.0",timestamp:new Date().toISOString()})}catch(a){return console.error("Batch event error:",a),b.status(500).json({error:"batch_processing_failed",message:a.message,sdk_version:"1.0.0",timestamp:new Date().toISOString()})}}async function p(a,b){try{if(Array.isArray(a.body.events))return await o(a,b);let c=s.safeParse(a.body);if(!c.success)return b.status(400).json({error:"invalid_event_parameters",details:c.error.issues,sdk_version:"1.0.0"});let{campaign_id:d,ad_id:e,ride_id:f,device_id:g=null,zone:h="post-ride",event_type:l,meta:m={}}=c.data,{normalizedData:n,rideRef:p}=i({ride_id:f,campaign_id:d,ad_id:e}),t=await k(async()=>{let a={campaign_id:n.campaign_id,ad_id:n.ad_id,event_type:l,device_id:g,region:h,ride_id:n.ride_id,meta:m,occurred_at:new Date().toISOString()};p&&(a.ride_ref=p);let{data:b,error:c}=await r.from("analytics_events").insert(a).select().single();if(c)throw c;return b},"Event insertion"),u=await j(t.id);if(u||console.warn("Event insertion verification failed for:",t.id),"click"===l)try{await k(()=>q(n.ride_id,n.campaign_id,n.ad_id),"Driver payout")}catch(a){console.error("Payout failed but event recorded:",a)}return b.status(200).json({success:!0,event_id:t.id,ride_id:n.ride_id,event_type:l,verified:u,sdk_version:"1.0.0",timestamp:new Date().toISOString()})}catch(a){return console.error("Record event error:",a),b.status(500).json({error:"event_recording_failed",message:a.message,sdk_version:"1.0.0",timestamp:new Date().toISOString()})}}async function q(a,b,c){try{let{data:b,error:c}=await r.from("rides").select("driver_id").eq("id",a).single();if(c||!b)return void console.log("No ride found for payout:",a);let{data:d,error:e}=await r.from("driver_wallet").select("balance_cents, ad_earnings").eq("driver_id",b.driver_id).single();if(e){console.log("Driver wallet not found, creating new one");let{error:a}=await r.from("driver_wallet").insert({driver_id:b.driver_id,balance_cents:10,ad_earnings:10});if(a)throw a}else{let{error:a}=await r.from("driver_wallet").update({balance_cents:(d.balance_cents||0)+10,ad_earnings:(d.ad_earnings||0)+10}).eq("driver_id",b.driver_id);if(a)throw a}}catch(a){console.error("Driver payout error:",a)}}d()}catch(a){d(a)}})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[7169],()=>b(b.s=2480));module.exports=c})();